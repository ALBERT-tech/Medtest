// ПЕРЕПИСАННЫЙ admin-app.js — БЕЗ СЕКРЕТОВ!
// Все секреты на backend, фронтенд работает через API

// Конфигурация (БЕЗ КЛЮЧЕЙ И ПАРОЛЕЙ!)\nconst BACKEND_URL = 'https://your-backend-url.com'; // Адрес backend сервера\n// Или для локального тестирования:\n// const BACKEND_URL = 'http://localhost:5000';\n\n// Состояние админ-панели\nconst adminState = {\n    isLoggedIn: false,\n    jwtToken: null,  // JWT токен от backend\n    allData: [],\n    filteredData: [],\n    fromDate: null,\n    toDate: null,\n};\n\n// Инициализация\ndocument.addEventListener('DOMContentLoaded', () => {\n    document.getElementById('login-form').addEventListener('submit', handleLogin);\n    document.getElementById('btn-logout').addEventListener('click', handleLogout);\n    document.getElementById('btn-apply-filters').addEventListener('click', handleApplyFilters);\n    document.getElementById('btn-export-excel').addEventListener('click', handleExportExcel);\n    document.getElementById('btn-export-csv').addEventListener('click', handleExportCSV);\n    document.getElementById('btn-export-json').addEventListener('click', handleExportJSON);\n\n    // Проверить, есть ли сохранённый JWT токен\n    const savedToken = localStorage.getItem('admin_jwt_token');\n    const tokenExpiry = parseInt(localStorage.getItem('admin_token_expiry')) || 0;\n\n    if (savedToken && tokenExpiry > Date.now()) {\n        adminState.jwtToken = savedToken;\n        adminState.isLoggedIn = true;\n        loadData();\n        showScreen('admin');\n    }\n});\n\n/**\n * Отправить пароль на backend\n * Backend сравнит с bcrypt хешем и вернёт JWT токен\n */\nasync function handleLogin(e) {\n    e.preventDefault();\n\n    const passwordInput = document.getElementById('password');\n    const password = passwordInput.value;\n    const errorDiv = document.getElementById('login-error');\n\n    if (!password) {\n        errorDiv.textContent = 'Введите пароль';\n        return;\n    }\n\n    try {\n        showStatus('Проверка пароля...', 'loading');\n\n        // Отправить пароль на backend\n        const response = await fetch(`${BACKEND_URL}/admin/login`, {\n            method: 'POST',\n            headers: {\n                'Content-Type': 'application/json'\n            },\n            body: JSON.stringify({ password })\n        });\n\n        if (!response.ok) {\n            const error = await response.json();\n            throw new Error(error.error || 'Неверный пароль');\n        }\n\n        const data = await response.json();\n        const jwtToken = data.token;\n\n        // Сохранить JWT токен (действует 1 час)\n        adminState.jwtToken = jwtToken;\n        adminState.isLoggedIn = true;\n\n        // Сохранить в localStorage\n        localStorage.setItem('admin_jwt_token', jwtToken);\n        const expiryTime = Date.now() + (60 * 60 * 1000); // +1 час\n        localStorage.setItem('admin_token_expiry', expiryTime);\n\n        errorDiv.textContent = '';\n        passwordInput.value = '';\n\n        loadData();\n        showScreen('admin');\n        showStatus('✓ Вход выполнен', 'success');\n\n    } catch (error) {\n        console.error('Login error:', error);\n        errorDiv.textContent = error.message || 'Ошибка входа';\n        passwordInput.select();\n        showStatus(`❌ ${error.message}`, 'error');\n    }\n}\n\n/**\n * Выход: удалить JWT токен\n */\nfunction handleLogout() {\n    localStorage.removeItem('admin_jwt_token');\n    localStorage.removeItem('admin_token_expiry');\n    adminState.jwtToken = null;\n    adminState.isLoggedIn = false;\n    adminState.allData = [];\n    adminState.filteredData = [];\n\n    document.getElementById('password').value = '';\n    document.getElementById('login-error').textContent = '';\n\n    showScreen('login');\n    showStatus('✓ Вы вышли из системы', 'success');\n}\n\n/**\n * Показать экран\n */\nfunction showScreen(screenName) {\n    document.querySelectorAll('.screen').forEach(screen => {\n        screen.classList.remove('active');\n    });\n    document.getElementById(`screen-${screenName}`).classList.add('active');\n}\n\n/**\n * Загрузить данные с backend\n * Используется JWT токен (НЕ Service Key!)\n */\nasync function loadData() {\n    try {\n        showStatus('Загрузка данных...', 'loading');\n\n        // Запрос к backend с JWT токеном\n        const response = await fetch(`${BACKEND_URL}/admin/responses`, {\n            method: 'GET',\n            headers: {\n                'Content-Type': 'application/json',\n                'Authorization': `Bearer ${adminState.jwtToken}` // JWT токен в заголовке\n            }\n        });\n\n        if (!response.ok) {\n            if (response.status === 401 || response.status === 403) {\n                handleLogout();\n                throw new Error('Сессия истекла. Пожалуйста, войдите снова.');\n            }\n            throw new Error(`Ошибка загрузки: ${response.status}`);\n        }\n\n        adminState.allData = await response.json();\n        adminState.filteredData = [...adminState.allData];\n\n        // Загрузить статистику\n        await loadStats();\n\n        renderTable();\n        showStatus('✓ Данные загружены');\n\n    } catch (error) {\n        console.error('Ошибка:', error);\n        showStatus(`❌ Ошибка: ${error.message}`, 'error');\n    }\n}\n\n/**\n * Загрузить статистику\n */\nasync function loadStats() {\n    try {\n        const response = await fetch(`${BACKEND_URL}/admin/responses/stats`, {\n            headers: {\n                'Authorization': `Bearer ${adminState.jwtToken}`\n            }\n        });\n\n        if (!response.ok) throw new Error('Failed to load stats');\n\n        const stats = await response.json();\n        document.getElementById('stat-total').textContent = stats.total;\n        document.getElementById('stat-avg-bmi').textContent = stats.avg_bmi;\n        document.getElementById('stat-latest').textContent = stats.latest_response\n            ? new Date(stats.latest_response).toLocaleString('ru-RU')\n            : '-';\n\n    } catch (error) {\n        console.error('Stats error:', error);\n        // Статистика не критична, можем посчитать на фронтенде\n        updateStats();\n    }\n}\n\n/**\n * Обновить статистику (фронтенд расчёт)\n */\nfunction updateStats() {\n    const data = adminState.filteredData;\n\n    document.getElementById('stat-total').textContent = data.length;\n\n    if (data.length > 0) {\n        const latestDate = new Date(data[0].created_at);\n        document.getElementById('stat-latest').textContent = latestDate.toLocaleString('ru-RU');\n    }\n\n    if (data.length > 0) {\n        const bmiValues = data\n            .map(row => parseFloat(row.computed?.bmi || 0))\n            .filter(bmi => bmi > 0);\n\n        if (bmiValues.length > 0) {\n            const avgBmi = (bmiValues.reduce((a, b) => a + b, 0) / bmiValues.length).toFixed(1);\n            document.getElementById('stat-avg-bmi').textContent = avgBmi;\n        }\n    }\n}\n\n/**\n * Применить фильтры по датам\n */\nfunction handleApplyFilters() {\n    const fromDate = document.getElementById('filter-from-date').value;\n    const toDate = document.getElementById('filter-to-date').value;\n\n    adminState.filteredData = adminState.allData.filter(row => {\n        const rowDate = new Date(row.created_at);\n\n        if (fromDate && new Date(fromDate) > rowDate) return false;\n        if (toDate && new Date(toDate) < rowDate) return false;\n\n        return true;\n    });\n\n    updateStats();\n    renderTable();\n    showStatus(`✓ Фильтры применены (${adminState.filteredData.length} записей)`);\n}\n\n/**\n * Отобразить таблицу\n */\nfunction renderTable() {\n    const data = adminState.filteredData;\n    const container = document.getElementById('table-container');\n\n    if (data.length === 0) {\n        container.innerHTML = '<p class=\"loading\">Нет данных для отображения</p>';\n        return;\n    }\n\n    const previewData = data.slice(0, 10);\n\n    let html = '<table class=\"data-table\">';\n    html += '<thead><tr>';\n    html += '<th>Шифр</th>';\n    html += '<th>Дата</th>';\n    html += '<th>Возраст</th>';\n    html += '<th>Вес (кг)</th>';\n    html += '<th>Рост (см)</th>';\n    html += '<th>ИМТ</th>';\n    html += '<th>Недержание</th>';\n    html += '</tr></thead>';\n    html += '<tbody>';\n\n    previewData.forEach(row => {\n        const answers = row.answers || {};\n        const computed = row.computed || {};\n        const date = new Date(row.created_at).toLocaleString('ru-RU');\n\n        html += '<tr>';\n        html += `<td>${row.code}</td>`;\n        html += `<td>${date}</td>`;\n        html += `<td>${answers.age || '-'}</td>`;\n        html += `<td>${answers.weight_kg || '-'}</td>`;\n        html += `<td>${answers.height_cm || '-'}</td>`;\n        html += `<td>${computed.bmi || '-'}</td>`;\n        html += `<td>${answers.incontinence_episodes || '-'}</td>`;\n        html += '</tr>';\n    });\n\n    html += '</tbody></table>';\n\n    if (data.length > 10) {\n        html += `<p class=\"table-note\">Показано 10 из ${data.length} записей. Нажми \"Скачать Excel\" для выгрузки всех.</p>`;\n    }\n\n    container.innerHTML = html;\n}\n\n/**\n * Экспортировать в Excel\n */\nfunction handleExportExcel() {\n    try {\n        showStatus('Создание Excel файла...');\n\n        const data = adminState.filteredData;\n        if (data.length === 0) {\n            showStatus('❌ Нет данных для выгрузки');\n            return;\n        }\n\n        const excelData = data.map(row => {\n            const answers = row.answers || {};\n            const computed = row.computed || {};\n\n            return {\n                'Шифр': row.code,\n                'Дата': new Date(row.created_at).toLocaleString('ru-RU'),\n                'Возраст (лет)': answers.age || '',\n                'Роды (раз)': answers.births || '',\n                'Вес (кг)': answers.weight_kg || '',\n                'Рост (см)': answers.height_cm || '',\n                'Окружность талии (см)': answers.waist_circumference || '',\n                'Дневные микции': answers.daytime_micturitions || '',\n                'Ночные микции': answers.nighttime_micturitions || '',\n                'Жидкость (мл)': answers.fluid_intake_ml || '',\n                'Моча (мл)': answers.urine_output_ml || '',\n                'Позывы': answers.urgent_urges || '',\n                'Недержание (раз/сут)': answers.incontinence_episodes || '',\n                'Прокладки': answers.pads_per_day || '',\n                'Энурез (лет)': answers.childhood_enuresis || '',\n                'ИМТ': computed.bmi || '',\n                'Согласие': row.consent ? 'Да' : 'Нет'\n            };\n        });\n\n        const ws = XLSX.utils.json_to_sheet(excelData);\n        const wb = XLSX.utils.book_new();\n        XLSX.utils.book_append_sheet(wb, ws, 'Ответы');\n\n        const wscols = [\n            { wch: 12 }, { wch: 18 }, { wch: 10 }, { wch: 10 }, { wch: 10 }, { wch: 10 }, { wch: 15 },\n            { wch: 12 }, { wch: 12 }, { wch: 12 }, { wch: 10 }, { wch: 10 }, { wch: 14 }, { wch: 10 }, { wch: 10 }, { wch: 8 }, { wch: 10 }\n        ];\n        ws['!cols'] = wscols;\n\n        const filename = `responses_${new Date().toISOString().split('T')[0]}.xlsx`;\n        XLSX.writeFile(wb, filename);\n\n        showStatus(`✓ Excel выгружен: ${data.length} записей`);\n\n    } catch (error) {\n        console.error('Ошибка при экспорте в Excel:', error);\n        showStatus(`❌ Ошибка: ${error.message}`);\n    }\n}\n\n/**\n * Экспортировать в CSV\n */\nfunction handleExportCSV() {\n    try {\n        showStatus('Создание CSV файла...');\n\n        const data = adminState.filteredData;\n        if (data.length === 0) {\n            showStatus('❌ Нет данных для выгрузки');\n            return;\n        }\n\n        const headers = [\n            'Шифр', 'Дата', 'Возраст', 'Роды', 'Вес', 'Рост', 'Окружность',\n            'Дневные микции', 'Ночные микции', 'Жидкость', 'Моча', 'Позывы',\n            'Недержание', 'Прокладки', 'Энурез', 'ИМТ', 'Согласие'\n        ];\n\n        let csv = headers.join(',') + '\\n';\n\n        data.forEach(row => {\n            const answers = row.answers || {};\n            const computed = row.computed || {};\n\n            const values = [\n                `\"${row.code}\"`,\n                `\"${new Date(row.created_at).toLocaleString('ru-RU')}\"`,\n                answers.age || '',\n                answers.births || '',\n                answers.weight_kg || '',\n                answers.height_cm || '',\n                answers.waist_circumference || '',\n                answers.daytime_micturitions || '',\n                answers.nighttime_micturitions || '',\n                answers.fluid_intake_ml || '',\n                answers.urine_output_ml || '',\n                answers.urgent_urges || '',\n                answers.incontinence_episodes || '',\n                answers.pads_per_day || '',\n                answers.childhood_enuresis || '',\n                computed.bmi || '',\n                row.consent ? 'Да' : 'Нет'\n            ];\n\n            csv += values.join(',') + '\\n';\n        });\n\n        downloadFile(csv, `responses_${new Date().toISOString().split('T')[0]}.csv`, 'text/csv');\n        showStatus(`✓ CSV выгружен: ${data.length} записей`);\n\n    } catch (error) {\n        console.error('Ошибка при экспорте в CSV:', error);\n        showStatus(`❌ Ошибка: ${error.message}`);\n    }\n}\n\n/**\n * Экспортировать в JSON\n */\nfunction handleExportJSON() {\n    try {\n        showStatus('Создание JSON файла...');\n\n        const data = adminState.filteredData;\n        if (data.length === 0) {\n            showStatus('❌ Нет данных для выгрузки');\n            return;\n        }\n\n        const json = JSON.stringify(data, null, 2);\n        downloadFile(json, `responses_${new Date().toISOString().split('T')[0]}.json`, 'application/json');\n\n        showStatus(`✓ JSON выгружен: ${data.length} записей`);\n\n    } catch (error) {\n        console.error('Ошибка при экспорте в JSON:', error);\n        showStatus(`❌ Ошибка: ${error.message}`);\n    }\n}\n\n/**\n * Утилита для скачивания файла\n */\nfunction downloadFile(content, filename, mimeType) {\n    const blob = new Blob([content], { type: mimeType });\n    const url = URL.createObjectURL(blob);\n    const link = document.createElement('a');\n    link.href = url;\n    link.download = filename;\n    document.body.appendChild(link);\n    link.click();\n    document.body.removeChild(link);\n    URL.revokeObjectURL(url);\n}\n\n/**\n * Показать статус\n */\nfunction showStatus(message, type = 'info') {\n    const statusDiv = document.getElementById('export-status');\n    statusDiv.textContent = message;\n    statusDiv.className = `status-message ${type}`;\n    statusDiv.style.display = 'block';\n\n    if (type !== 'loading') {\n        setTimeout(() => {\n            statusDiv.style.display = 'none';\n        }, 3000);\n    }\n}\n